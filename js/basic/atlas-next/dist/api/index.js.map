{"version":3,"sources":["../../src/api/index.ts","../../src/api/edgeCache.ts","../../src/api/kv.ts","../../src/api/api.ts"],"sourcesContent":["import { EdgeCache } from './edgeCache'\nimport { KV } from './kv'\n\nexport { EdgeCache, KV }\n","import { purgePaths, purgeTags } from '@wpengine/edge-cache'\n\nexport class EdgeCache {\n  /**\n   * Purge the edge cache by tags\n   * @param string[]\n   */\n  async purgeByTags(tags: string[]): Promise<any> {\n    await purgeTags(tags)\n  }\n\n  /**\n   * Purge the edge cache by paths\n   * @param string[]\n   */\n  async purgeByPaths(paths: string[]): Promise<any> {\n    await purgePaths(paths)\n  }\n}\n","import fetch from 'node-fetch'\nimport { API } from './api'\n\nexport class KV extends API {\n  private readonly token: string\n  private readonly url: string\n\n  static isAvailable(): boolean {\n    const urlExists = (process.env.HEADLESS_KV_STORE_URL ?? '') !== ''\n    const tokenExists = (process.env.HEADLESS_KV_STORE_TOKEN ?? '') !== ''\n    const atlasRuntime =\n      String(process.env.HEADLESS_METADATA).toLowerCase() === 'true'\n    return urlExists && tokenExists && atlasRuntime\n  }\n\n  constructor() {\n    super()\n    if (process.env.HEADLESS_METADATA !== 'true') {\n      throw new Error('KV: The app is not running on the Atlas Platform')\n    }\n\n    this.url = process.env.HEADLESS_KV_STORE_URL ?? ''\n    if (this.url === '') {\n      throw new Error('KV: HEADLESS_KV_STORE_URL env var is missing')\n    }\n\n    this.token = process.env.HEADLESS_KV_STORE_TOKEN ?? ''\n    if (this.token === '') {\n      throw new Error('KV: HEADLESS_KV_STORE_TOKEN env var is missing')\n    }\n  }\n\n  async get(key: string): Promise<any> {\n    const response = await fetch(`${this.url}/${key}`, {\n      headers: {\n        Authorization: `Bearer ${this.token}`,\n        'User-Agent': `AtlasNext/${this.version}`\n      }\n    })\n\n    this.throwResponseErrors(response, key)\n\n    return await response.json()\n  }\n\n  async set(key: string, data: any): Promise<void> {\n    if (data === null) {\n      return\n    }\n\n    const response = await fetch(`${this.url}/${key}`, {\n      method: 'PUT',\n      body: JSON.stringify(data),\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${this.token}`,\n        'User-Agent': `AtlasNext/${this.version}`\n      }\n    })\n\n    this.throwResponseErrors(response, key)\n  }\n}\n","import { type Response } from 'node-fetch'\n\nexport class APIError extends Error {\n  public response\n\n  constructor(response: Response, key: string) {\n    super(\n      `HTTP Error Response: ${response.status} ${response.statusText} for key(s): ${key}`\n    )\n    this.response = response\n  }\n}\n\nexport class APINotFoundError extends Error {}\n\nexport abstract class API {\n  // The atlas-next package version will be injected from package.json\n  // at build time by esbuild-plugin-version-injector\n  protected readonly version: string = '1.4.1'\n\n  constructor() {\n    if (process.env.HEADLESS_METADATA !== 'true') {\n      throw new Error('API: The app is not running on the Atlas Platform')\n    }\n  }\n\n  /**\n   * Convert response status codes to API errors and throw them\n   * @param response\n   * @param key\n   */\n  protected throwResponseErrors(response: Response, key: string): void {\n    if (response.status === 404) {\n      throw new APINotFoundError()\n    }\n    if (response.status < 200 || response.status >= 300) {\n      throw new APIError(response, key)\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACAA,wBAAsC;AAE/B,IAAM,YAAN,MAAgB;AAAA;AAAA;AAAA;AAAA;AAAA,EAKrB,MAAM,YAAY,MAA8B;AAC9C,cAAM,6BAAU,IAAI;AAAA,EACtB;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,aAAa,OAA+B;AAChD,cAAM,8BAAW,KAAK;AAAA,EACxB;AACF;;;AClBA,wBAAkB;;;ACEX,IAAM,WAAN,cAAuB,MAAM;AAAA,EAC3B;AAAA,EAEP,YAAY,UAAoB,KAAa;AAC3C;AAAA,MACE,wBAAwB,SAAS,MAAM,IAAI,SAAS,UAAU,gBAAgB,GAAG;AAAA,IACnF;AACA,SAAK,WAAW;AAAA,EAClB;AACF;AAEO,IAAM,mBAAN,cAA+B,MAAM;AAAC;AAEtC,IAAe,MAAf,MAAmB;AAAA;AAAA;AAAA,EAGL,UAAkB;AAAA,EAErC,cAAc;AACZ,QAAI,QAAQ,IAAI,sBAAsB,QAAQ;AAC5C,YAAM,IAAI,MAAM,mDAAmD;AAAA,IACrE;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOU,oBAAoB,UAAoB,KAAmB;AACnE,QAAI,SAAS,WAAW,KAAK;AAC3B,YAAM,IAAI,iBAAiB;AAAA,IAC7B;AACA,QAAI,SAAS,SAAS,OAAO,SAAS,UAAU,KAAK;AACnD,YAAM,IAAI,SAAS,UAAU,GAAG;AAAA,IAClC;AAAA,EACF;AACF;;;ADpCO,IAAM,KAAN,cAAiB,IAAI;AAAA,EACT;AAAA,EACA;AAAA,EAEjB,OAAO,cAAuB;AAC5B,UAAM,aAAa,QAAQ,IAAI,yBAAyB,QAAQ;AAChE,UAAM,eAAe,QAAQ,IAAI,2BAA2B,QAAQ;AACpE,UAAM,eACJ,OAAO,QAAQ,IAAI,iBAAiB,EAAE,YAAY,MAAM;AAC1D,WAAO,aAAa,eAAe;AAAA,EACrC;AAAA,EAEA,cAAc;AACZ,UAAM;AACN,QAAI,QAAQ,IAAI,sBAAsB,QAAQ;AAC5C,YAAM,IAAI,MAAM,kDAAkD;AAAA,IACpE;AAEA,SAAK,MAAM,QAAQ,IAAI,yBAAyB;AAChD,QAAI,KAAK,QAAQ,IAAI;AACnB,YAAM,IAAI,MAAM,8CAA8C;AAAA,IAChE;AAEA,SAAK,QAAQ,QAAQ,IAAI,2BAA2B;AACpD,QAAI,KAAK,UAAU,IAAI;AACrB,YAAM,IAAI,MAAM,gDAAgD;AAAA,IAClE;AAAA,EACF;AAAA,EAEA,MAAM,IAAI,KAA2B;AACnC,UAAM,WAAW,UAAM,kBAAAA,SAAM,GAAG,KAAK,GAAG,IAAI,GAAG,IAAI;AAAA,MACjD,SAAS;AAAA,QACP,eAAe,UAAU,KAAK,KAAK;AAAA,QACnC,cAAc,aAAa,KAAK,OAAO;AAAA,MACzC;AAAA,IACF,CAAC;AAED,SAAK,oBAAoB,UAAU,GAAG;AAEtC,WAAO,MAAM,SAAS,KAAK;AAAA,EAC7B;AAAA,EAEA,MAAM,IAAI,KAAa,MAA0B;AAC/C,QAAI,SAAS,MAAM;AACjB;AAAA,IACF;AAEA,UAAM,WAAW,UAAM,kBAAAA,SAAM,GAAG,KAAK,GAAG,IAAI,GAAG,IAAI;AAAA,MACjD,QAAQ;AAAA,MACR,MAAM,KAAK,UAAU,IAAI;AAAA,MACzB,SAAS;AAAA,QACP,gBAAgB;AAAA,QAChB,eAAe,UAAU,KAAK,KAAK;AAAA,QACnC,cAAc,aAAa,KAAK,OAAO;AAAA,MACzC;AAAA,IACF,CAAC;AAED,SAAK,oBAAoB,UAAU,GAAG;AAAA,EACxC;AACF;","names":["fetch"]}