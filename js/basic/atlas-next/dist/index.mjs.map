{"version":3,"sources":["../src/config.ts"],"sourcesContent":["import { type NextConfig } from 'next'\nimport path from 'path'\n\nexport interface AtlasConfig extends Record<string, any> {\n  /**\n   * If set to `false`, the Atlas remote cache handler will not be added (defaults to true)\n   */\n  remoteCacheHandler?: boolean\n}\n\n/**\n * Add Atlas options to the config to be exported from the user's Next.js config file\n * @param nextConfig\n * @param atlasConfig\n * @returns The modified config\n */\nexport function withAtlasConfig(\n  nextConfig: NextConfig,\n  atlasConfig?: AtlasConfig\n): NextConfig {\n  if (atlasConfig?.remoteCacheHandler === false) {\n    return nextConfig\n  }\n\n  /* eslint-disable @typescript-eslint/no-var-requires */\n  // Get the next.js version\n  const nextModulePath = path.parse(require.resolve('next'))\n  const nextPackage = require(\n    path.join(nextModulePath.dir, '../../package.json')\n  )\n\n  try {\n    return setCacheHandler(\n      nextConfig,\n      nextPackage.version,\n      // TODO: look closer how this can be stubbed to enable testing\n      // of the withAtlasConfig function\n      require.resolve('@wpengine/atlas-next/cache-handler')\n    )\n  } catch (error) {\n    console.warn('Setting cache handler config', error)\n    return nextConfig\n  }\n}\n\nexport function setCacheHandler(\n  nextConfig: NextConfig,\n  nextVersion: string,\n  cacheHandlerPath: string\n): NextConfig {\n  // If next.js version is less than 12.2.0\n  if (\n    compare(nextVersion, '12.2.0') === -1 ||\n    compare(nextVersion, '13.4') === 0\n  ) {\n    throw new Error(\n      'The Atlas remote cache handler does not support Next.js version ' +\n        nextVersion\n    )\n  }\n\n  // If next.js version is less than 14.1.0 (and greater than or equal to 12.2.0)\n  if (compare(nextVersion, '14.1.0') === -1) {\n    nextConfig.experimental = nextConfig.experimental ?? {}\n    if (nextConfig.experimental.incrementalCacheHandlerPath !== undefined) {\n      console.warn('Overwriting existing incrementalCacheHandlerPath config')\n    }\n    nextConfig.experimental.incrementalCacheHandlerPath = cacheHandlerPath\n    if (nextConfig.experimental.isrMemoryCacheSize !== undefined) {\n      console.warn('Overwriting existing isrMemoryCacheSize config')\n    }\n    nextConfig.experimental.isrMemoryCacheSize = 0\n    return nextConfig\n  }\n\n  // If next.js version is 14.1.0 or higher\n  if (nextConfig.cacheHandler !== undefined) {\n    console.warn('Overwriting existing cacheHandler config')\n  }\n  nextConfig.cacheHandler = cacheHandlerPath\n  if (nextConfig.cacheMaxMemorySize !== undefined) {\n    console.warn('Overwriting existing cacheMaxMemorySize config')\n  }\n  nextConfig.cacheMaxMemorySize = 0\n  return nextConfig\n}\n\n// Compares only major and minor versions\n// The function is created to not add an external dependency to the package.\nexport function compare(v1: string, v2: string): number {\n  validateVersion(v1)\n  validateVersion(v2)\n\n  const v1Parts = v1.split('.')\n  const v1Major = v1Parts[0]\n  const v1Minor = v1Parts[1]\n  const v2Parts = v2.split('.')\n  const v2Major = v2Parts[0]\n  const v2Minor = v2Parts[1]\n\n  const v1MinorLesserOrEqual = v1Minor < v2Minor ? -1 : 0\n  const compareMinorVersions = v1Minor > v2Minor ? 1 : v1MinorLesserOrEqual\n  const v1MajorLesserOrEqual = v1Major < v2Major ? -1 : compareMinorVersions\n\n  return v1Major > v2Major ? 1 : v1MajorLesserOrEqual\n}\n\nexport function validateVersion(version: string): void {\n  if (version.length === 0) {\n    throw new Error('invalid version')\n  }\n  const parts = version.split('.')\n  if (parts.length < 2) {\n    throw new Error('invalid version')\n  }\n  const major = parts[0]\n  if (major.length === 0 || isNaN(Number(major))) {\n    throw new Error('invalid version')\n  }\n  const minor = parts[1]\n  if (minor.length === 0 || isNaN(Number(minor))) {\n    throw new Error('invalid version')\n  }\n}\n"],"mappings":";;;;;;;;;AACA,OAAO,UAAU;AAeV,SAAS,gBACd,YACA,aACY;AACZ,MAAI,aAAa,uBAAuB,OAAO;AAC7C,WAAO;AAAA,EACT;AAIA,QAAM,iBAAiB,KAAK,MAAM,UAAQ,QAAQ,MAAM,CAAC;AACzD,QAAM,cAAc,UAClB,KAAK,KAAK,eAAe,KAAK,oBAAoB,CACpD;AAEA,MAAI;AACF,WAAO;AAAA,MACL;AAAA,MACA,YAAY;AAAA;AAAA;AAAA,MAGZ,UAAQ,QAAQ,oCAAoC;AAAA,IACtD;AAAA,EACF,SAAS,OAAO;AACd,YAAQ,KAAK,gCAAgC,KAAK;AAClD,WAAO;AAAA,EACT;AACF;AAEO,SAAS,gBACd,YACA,aACA,kBACY;AAEZ,MACE,QAAQ,aAAa,QAAQ,MAAM,MACnC,QAAQ,aAAa,MAAM,MAAM,GACjC;AACA,UAAM,IAAI;AAAA,MACR,qEACE;AAAA,IACJ;AAAA,EACF;AAGA,MAAI,QAAQ,aAAa,QAAQ,MAAM,IAAI;AACzC,eAAW,eAAe,WAAW,gBAAgB,CAAC;AACtD,QAAI,WAAW,aAAa,gCAAgC,QAAW;AACrE,cAAQ,KAAK,yDAAyD;AAAA,IACxE;AACA,eAAW,aAAa,8BAA8B;AACtD,QAAI,WAAW,aAAa,uBAAuB,QAAW;AAC5D,cAAQ,KAAK,gDAAgD;AAAA,IAC/D;AACA,eAAW,aAAa,qBAAqB;AAC7C,WAAO;AAAA,EACT;AAGA,MAAI,WAAW,iBAAiB,QAAW;AACzC,YAAQ,KAAK,0CAA0C;AAAA,EACzD;AACA,aAAW,eAAe;AAC1B,MAAI,WAAW,uBAAuB,QAAW;AAC/C,YAAQ,KAAK,gDAAgD;AAAA,EAC/D;AACA,aAAW,qBAAqB;AAChC,SAAO;AACT;AAIO,SAAS,QAAQ,IAAY,IAAoB;AACtD,kBAAgB,EAAE;AAClB,kBAAgB,EAAE;AAElB,QAAM,UAAU,GAAG,MAAM,GAAG;AAC5B,QAAM,UAAU,QAAQ,CAAC;AACzB,QAAM,UAAU,QAAQ,CAAC;AACzB,QAAM,UAAU,GAAG,MAAM,GAAG;AAC5B,QAAM,UAAU,QAAQ,CAAC;AACzB,QAAM,UAAU,QAAQ,CAAC;AAEzB,QAAM,uBAAuB,UAAU,UAAU,KAAK;AACtD,QAAM,uBAAuB,UAAU,UAAU,IAAI;AACrD,QAAM,uBAAuB,UAAU,UAAU,KAAK;AAEtD,SAAO,UAAU,UAAU,IAAI;AACjC;AAEO,SAAS,gBAAgB,SAAuB;AACrD,MAAI,QAAQ,WAAW,GAAG;AACxB,UAAM,IAAI,MAAM,iBAAiB;AAAA,EACnC;AACA,QAAM,QAAQ,QAAQ,MAAM,GAAG;AAC/B,MAAI,MAAM,SAAS,GAAG;AACpB,UAAM,IAAI,MAAM,iBAAiB;AAAA,EACnC;AACA,QAAM,QAAQ,MAAM,CAAC;AACrB,MAAI,MAAM,WAAW,KAAK,MAAM,OAAO,KAAK,CAAC,GAAG;AAC9C,UAAM,IAAI,MAAM,iBAAiB;AAAA,EACnC;AACA,QAAM,QAAQ,MAAM,CAAC;AACrB,MAAI,MAAM,WAAW,KAAK,MAAM,OAAO,KAAK,CAAC,GAAG;AAC9C,UAAM,IAAI,MAAM,iBAAiB;AAAA,EACnC;AACF;","names":[]}